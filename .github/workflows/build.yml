name: Build EXE

on:
  workflow_dispatch: 

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Debug - List Files
      run: |
        echo "Listing all files in the repository to debug names:"
        dir /s

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if (Test-Path requirements.txt) {
            pip install -r requirements.txt
        }

    - name: Locate Script and Build
      run: |
        $scriptPath = Get-ChildItem -Filter "ExtractorGUI.py" -Recurse | Select-Object -First 1 -ExpandProperty FullName
        
        if (-not $scriptPath) {
            $scriptPath = Get-ChildItem -Filter "extractorgui.py" -Recurse | Select-Object -First 1 -ExpandProperty FullName
        }

        if (-not $scriptPath) {
            echo "Specific name not found, searching for any Python script..."
            $scriptPath = Get-ChildItem -Include "*.py","*.PY" -Recurse | Where-Object { $_.Name -notlike "build.py" -and $_.FullName -notlike "*venv*" } | Select-Object -First 1 -ExpandProperty FullName
        }

        if ($scriptPath) {
            echo "Target script identified at: $scriptPath"
            pyinstaller --onefile --noconsole --clean $scriptPath
        } else {
            echo "ERROR: No Python script (.py) found in the entire repository."
            echo "Please check the 'Debug - List Files' step above to see how your files are named."
            exit 1
        }

    - name: Verify Build
      run: |
        if (Test-Path dist/*.exe) {
            echo "Build successful. Executable generated in dist folder."
        } else {
            echo "Build failed: Output EXE not found."
            exit 1
        }

    - name: Upload EXE Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ExtractorGUI-Windows-Build
        path: dist/*.exe
        retention-days: 7
