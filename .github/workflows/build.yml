name: Build EXE

on:
  workflow_dispatch: 

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Debug - List All Files
      run: |
        echo "Checking current directory and listing all files:"
        pwd
        Get-ChildItem -Recurse | Select-Object FullName

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if (Test-Path requirements.txt) {
            pip install -r requirements.txt
        }

    - name: Locate Script and Build
      run: |
        $scripts = Get-ChildItem -Include "*.py","*.PY" -Recurse | Where-Object { $_.Name -notlike "build.yml" -and $_.FullName -notlike "*venv*" }
        
        if ($scripts.Count -eq 0) {
            echo "ERROR: No Python script (.py) found in the entire repository."
            exit 1
        }

        $targetScript = $scripts | Where-Object { $_.Name -ieq "ExtractorGUI.py" } | Select-Object -First 1
        if (-not $targetScript) {
            $targetScript = $scripts | Select-Object -First 1
            echo "Warning: ExtractorGUI.py not found. Using alternative: $($targetScript.Name)"
        }

        echo "Target script identified at: $($targetScript.FullName)"
        pyinstaller --onefile --noconsole --clean "$($targetScript.FullName)"

    - name: Verify Build
      run: |
        if (Test-Path dist/*.exe) {
            echo "Build successful. Executable generated in dist folder."
            Get-ChildItem dist/*.exe
        } else {
            echo "Build failed: Output EXE not found."
            exit 1
        }

    - name: Upload EXE Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ExtractorGUI-Windows-Build
        path: dist/*.exe
        retention-days: 7
